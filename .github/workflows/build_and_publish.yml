name: Build and Publish Docker Image


on:
  push:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  docker:
    runs-on: ubuntu-latest
    name: Release - ${{ matrix.platform.os-name }}
    strategy:
      matrix:
        platform:
          # - os-name: linuxarm64
          #   runs-on: ubuntu-24.04
          #   target: aarch64-unknown-linux-musl
          #   docker-platform: linux/arm64
          - os-name: amd64
            runs-on: ubuntu-24.04
            target: x86_64-unknown-linux-musl
            docker-platform: linux/amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: git clone geph5
        run: git clone https://github.com/geph-official/geph5 --depth 1

      - name: Build binary
        uses: houseabsolute/actions-rust-cross@v1     
        env:
          RUSTFLAGS: "-C opt-level=z -C lto -C embed-bitcode -C panic=abort -C codegen-units=1"
        with:
          working-directory: geph5
          command: build
          target: ${{ matrix.platform.target }}
          args: "--locked --release -p geph5-client"
          strip: true

      - name: List build directory
        run: ls -lah geph5/target/ && ls -lah geph5/target/release/

      - name: List binary directory
        run: ls -lah geph5/target/${{ matrix.platform.target }}/release/

      - name: Build Docker Image
        run: docker build -t icealtria/geph5-client:latest .
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform.docker-platform }}
          push: true
          tags: icealtria/geph5-client:latest

name: Build and Publish Docker Image


on:
  push:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  docker:
    runs-on: ubuntu-latest
    name: Release - ${{ matrix.platform.os-name }}
    strategy:
      matrix:
        platform:
          - os-name: Linux-aarch64
            runs-on: ubuntu-24.04
            target: aarch64-unknown-linux-musl
        toolchain:
          - stable
          
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: git clone geph5
        run: git clone https://github.com/geph-official/geph5 --depth 1

      - name: Build binary
        uses: houseabsolute/actions-rust-cross@v1
        with:
          working-directory: geph5
          command: build
          target: ${{ matrix.platform.target }}
          args: "--locked --release -p geph5-client"
          strip: true

      - name: List build directory
        run: ls -lah geph5/target/

      - name: Build Docker Image
        run: docker build -t icealtria/geph5-client:latest .
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: icealtria/geph5-client:latest
